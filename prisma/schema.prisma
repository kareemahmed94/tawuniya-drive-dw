// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  email     String    @unique
  password  String
  phone     String?   @unique
  avatar    String?
  role      AdminRole @default(ADMIN)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedAt DateTime?  @map("deleted_at") @db.Timestamp(6)

  @@map("admins")
}

model User {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  first_name String
  last_name  String
  email      String   @unique
  password   String
  phone      String?  @unique
  username   String
  avatar     String?
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedAt  DateTime? @map("deleted_at") @db.Timestamp(6)

  // Relations
  wallet       Wallet?
  transactions Transaction[]

  @@index([email])
  @@index([phone])
  @@map("users")
}

model Wallet {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @unique @db.Uuid
  balance      Decimal  @default(0) @db.Decimal(10, 2)
  totalEarned  Decimal  @default(0) @map("total_earned") @db.Decimal(10, 2)
  totalBurned  Decimal  @default(0) @map("total_burned") @db.Decimal(10, 2)
  totalExpired Decimal  @default(0) @map("total_expired") @db.Decimal(10, 2)
  lastActivity DateTime @default(now()) @map("last_activity")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamp(6)

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  pointBalances PointBalance[]

  @@index([userId])
  @@map("wallets")
}

model PointBalance {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  walletId      String    @map("wallet_id") @db.Uuid
  points        Decimal   @db.Decimal(10, 2)
  earnedAt      DateTime  @default(now()) @map("earned_at")
  expiresAt     DateTime? @map("expires_at")
  isExpired     Boolean   @default(false) @map("is_expired")
  transactionId String    @unique @map("transaction_id") @db.Uuid
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedAt     DateTime?  @map("deleted_at") @db.Timestamp(6)

  // Relations
  wallet      Wallet      @relation(fields: [walletId], references: [id], onDelete: Cascade)
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([expiresAt])
  @@index([isExpired])
  @@map("point_balances")
}

model Service {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String          @unique
  description String?
  category    ServiceCategory
  isActive    Boolean         @default(true) @map("is_active")
  iconUrl     String?         @map("icon_url")
  createdAt   DateTime        @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedAt   DateTime?        @map("deleted_at") @db.Timestamp(6)

  // Relations
  configs      ServiceConfig[]
  transactions Transaction[]

  @@index([category])
  @@index([isActive])
  @@map("services")
}

model ServiceConfig {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  serviceId     String    @map("service_id") @db.Uuid
  ruleType      RuleType  @map("rule_type")
  pointsPerUnit Decimal   @map("points_per_unit") @db.Decimal(10, 2)
  unitAmount    Decimal   @map("unit_amount") @db.Decimal(10, 2)
  minAmount     Decimal?  @map("min_amount") @db.Decimal(10, 2)
  maxPoints     Decimal?  @map("max_points") @db.Decimal(10, 2)
  expiryDays    Int?      @map("expiry_days")
  isActive      Boolean   @default(true) @map("is_active")
  validFrom     DateTime  @default(now()) @map("valid_from")
  validUntil    DateTime? @map("valid_until")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedAt     DateTime?  @map("deleted_at") @db.Timestamp(6)

  // Relations
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([ruleType])
  @@index([isActive])
  @@map("service_configs")
}

model Transaction {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String            @map("user_id") @db.Uuid
  serviceId     String            @map("service_id") @db.Uuid
  type          TransactionType
  amount        Decimal           @db.Decimal(10, 2)
  points        Decimal           @db.Decimal(10, 2)
  balanceBefore Decimal           @map("balance_before") @db.Decimal(10, 2)
  balanceAfter  Decimal           @map("balance_after") @db.Decimal(10, 2)
  description   String?
  metadata      Json?
  status        TransactionStatus @default(COMPLETED)
  createdAt     DateTime          @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedAt     DateTime?          @map("deleted_at") @db.Timestamp(6)

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  service      Service       @relation(fields: [serviceId], references: [id])
  pointBalance PointBalance?

  @@index([userId])
  @@index([serviceId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

model GlobalConfig {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String     @unique
  value       String
  type        ConfigType
  description String?
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime   @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedAt   DateTime?  @map("deleted_at") @db.Timestamp(6)

  @@index([key])
  @@map("global_configs")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  STAFF
}

enum ConfigType {
  SYSTEM
  BUSINESS
  FEATURE
}

enum TransactionType {
  EARN
  BURN
  EXPIRED
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}

enum ServiceCategory {
  INSURANCE
  CAR_WASH
  TOWING
  RENTAL
  MAINTENANCE
  OTHER
}

enum RuleType {
  EARN
  BURN
}
